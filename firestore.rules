rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Collection users - Accès authentifié uniquement
    match /users/{userId} {
      allow read, write: if request.auth != null;
    }

    // Collection clients - Accès authentifié pour le backoffice
    match /clients/{clientId} {
      allow read, write: if request.auth != null;

      // Permettre aux utilisateurs liés de lire leurs propres données client
      allow read: if request.auth != null &&
                     request.auth.uid == resource.data.userId;
    }

    // Collection projects - Accès authentifié uniquement
    match /projects/{projectId} {
      allow read, write: if request.auth != null;
    }

    // Collection materials - Accès authentifié uniquement
    match /materials/{materialId} {
      allow read, write: if request.auth != null;
    }

    // Collection invitations - Règles spéciales
    match /invitations/{invitationId} {
      // Le backoffice peut tout faire
      allow read, write: if request.auth != null;

      // Les utilisateurs peuvent lire leurs propres invitations
      allow read: if request.auth != null &&
                     request.auth.token.email == resource.data.email;

      // Les utilisateurs peuvent mettre à jour le statut de leurs invitations
      allow update: if request.auth != null &&
                      request.auth.token.email == resource.data.email &&
                      // Seulement autoriser la modification du statut et dates d'acceptation
                      request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['status', 'acceptedAt']);
    }

    // Collection pour les documents/fichiers clients (si utilisée)
    match /client_documents/{documentId} {
      allow read, write: if request.auth != null;
    }

    // Collection pour les notifications (si utilisée)
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null;
    }

    // Collection invitationCodes - Règles spéciales pour l'inscription
    match /invitationCodes/{codeId} {
      // Les administrateurs authentifiés peuvent tout faire
      allow read, write: if request.auth != null;

      // Permettre la lecture et mise à jour pour la validation des codes (inscription)
      // Ceci est nécessaire pour que les utilisateurs non authentifiés puissent valider leur code
      allow read, update: if true;
    }

    // Collection admins - Accès authentifié uniquement
    match /admins/{adminId} {
      allow read, write: if request.auth != null;
    }
  }
}